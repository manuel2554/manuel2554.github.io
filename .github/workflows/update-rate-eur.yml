name: Update BCV EUR rate

on:
  schedule:
    - cron: "0 */6 * * *"   # cada 6 horas
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

            - name: Fetch EURVES rate (with fallback sources)
        run: |
          set -e

          URL1="https://pydolarve.org/api/v1/dollar?page=bcv&monitor=eur"
          URL2="https://open.er-api.com/v6/latest/EUR"

          echo "Trying source 1: $URL1"
          if curl -fsSL "$URL1" -o api.json; then
            echo "Source 1 OK"
          else
            echo "Source 1 FAILED. Trying source 2: $URL2"
            curl -fsSL "$URL2" -o api.json
            echo "Source 2 OK"
          fi

          echo "Saved api.json (first 300 chars):"
          head -c 300 api.json || true
          echo ""

          RATE=$(node -e "
            const fs=require('fs');
            const j=JSON.parse(fs.readFileSync('api.json','utf8'));

            let rate=null;

            // Intento formato pydolarve (si algún día funciona)
            const candidates = [
              j?.price, j?.rate, j?.data?.price, j?.data?.rate,
              j?.monitors?.eur?.price, j?.eur?.price
            ];
            for(const c of candidates){
              const n=Number(c);
              if(Number.isFinite(n) && n>0){ rate=n; break; }
            }

            // Formato open.er-api.com (gratis, sin key)
            if(!rate){
              const n = Number(j?.rates?.VES);
              if(Number.isFinite(n) && n>0) rate = n;
            }

            if(!rate){
              console.error('No se pudo extraer RATE. Revisa api.json completo.');
              process.exit(1);
            }
            process.stdout.write(String(rate));
          ")

          echo "RATE=$RATE" >> $GITHUB_ENV
          echo "RATE extracted: $RATE"

      - name: Update rate.json
        run: |
          node -e "
            const fs=require('fs');
            const rate=Number(process.env.RATE);
            if(!Number.isFinite(rate) || rate<=0){
              console.error('RATE invalida:', process.env.RATE);
              process.exit(1);
            }

            const data={
              pair:'EURVES',
              source:'Auto (6h)',
              rate: rate,
              updated: new Date().toISOString()
            };

            fs.writeFileSync('rate.json', JSON.stringify(data,null,2)+'\n','utf8');
            console.log('rate.json updated:', data);
          "

      - name: Commit and push if changed
        run: |
          git config user.name "brutalux-bot"
          git config user.email "actions@users.noreply.github.com"
          git add rate.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update EURVES rate"
          git push
