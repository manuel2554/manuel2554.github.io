name: Update BCV EUR rate

on:
  schedule:
    - cron: "0 */6 * * *"   # cada 6 horas
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch EURVES rate (external BCV reference)
        run: |
          set -e

          # Fuente externa: devuelve JSON.
          # Si algún día cambia, ajustamos esta URL.
          URL="https://pydolarve.org/api/v1/dollar?page=bcv&monitor=eur"
          echo "Fetching: $URL"

          curl -sS "$URL" -o api.json
          echo "API response saved to api.json"

          RATE=$(node -e "
            const fs=require('fs');
            const j=JSON.parse(fs.readFileSync('api.json','utf8'));

            // Intentar extraer la tasa de varios formatos posibles:
            let rate = null;

            // Caso 1: rate directo
            const direct = [j?.price, j?.rate, j?.data?.price, j?.data?.rate];
            for(const c of direct){
              const n = Number(c);
              if(Number.isFinite(n) && n>0){ rate=n; break; }
            }

            // Caso 2: si viene en array
            if(!rate && Array.isArray(j)){
              for(const it of j){
                const n = Number(it?.price || it?.rate);
                if(Number.isFinite(n) && n>0){ rate=n; break; }
              }
            }

            if(!rate){
              console.error('No se pudo extraer RATE. Revisa api.json');
              process.exit(1);
            }

            process.stdout.write(String(rate));
          ")

          echo "RATE=$RATE" >> $GITHUB_ENV
          echo "RATE extracted: $RATE"

      - name: Update rate.json
        run: |
          node -e "
            const fs=require('fs');
            const rate=Number(process.env.RATE);
            if(!Number.isFinite(rate) || rate<=0) process.exit(1);

            const data={
              pair:'EURVES',
              source:'BCV (referencial)',
              rate: rate,
              updated: new Date().toISOString()
            };

            fs.writeFileSync('rate.json', JSON.stringify(data,null,2)+'\n','utf8');
            console.log('rate.json updated:', data);
          "

      - name: Commit and push if changed
        run: |
          git config user.name "brutalux-bot"
          git config user.email "actions@users.noreply.github.com"
          git add rate.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update EURVES rate (BCV)"
          git push
